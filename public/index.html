<html>
    <head>
        <script src='js/mithril.js'></script>
        <style>
            body {
                font-family: sans-serif
            }

            .menu {
                background-color: lightgrey;
                padding-top: 8px;
                padding-bottom: 8px;
            }

            .menu a {
                padding-right: 8px;
                color: darkslategray;
            }

            .menu a.active {
                color: black;
                text-decoration: none;
            }
        </style>
        <title>BUNKER</title>
    </head>
    <body>
        <script>
            const Title = function(title) {
                return m('h1', {}, title);
            };

            const Menu = function(activeEntry) {
                return m('div.menu', [
                    m('a', {href: '#!/', className: activeEntry == 'home' ? 'active' : ''}, 'home'),
                    m('a', {href: '#!/notes', className: activeEntry == 'notes' ? 'active' : ''}, 'notes')
                ]);
            };

            const state = {
                notes: []
            };

            const Home = {
                view: function() {
                    return  [
                        Title('home'),
                        Menu('home')
                    ];
                }
            };

            const refreshNotes = function() {
                return m.request({
                    method: 'GET',
                    url: '/notes',
                    withCredentials: true,
                })
                .then(function(result) {
                    state.notes = result.sort(function(a, b) {
                        return a.time - b.time;
                    }).reverse();
                })
            };

            const Notes = {
                oninit: function() {
                    refreshNotes();
                },
                view: function() {
                    return  [
                        Title('notes'),
                        Menu('notes'),
                        m('input#noteInput'),
                        m('button', {
                            onclick: function() {
                                const inputField = document.querySelector('#noteInput');

                                return m.request({
                                    method: 'POST',
                                    url: '/note',
                                    withCredentials: true,
                                    data: { message: inputField.value, time: Date.now() }
                                })
                                .then(function() {
                                    inputField.value = '';
                                    refreshNotes();
                                });
                            }
                        }, 'send'),
                        m('div', state.notes.map(function(note) {
                            return m('div', note.message);
                        }))
                    ];
                }
            };

            m.route(document.body, '/', {
                '/': Home,
                '/notes': Notes
            });
        </script>
    </body>
</html>
